<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Coastok Admin Panel</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="../../vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="../../vendors/base/vendor.bundle.base.css">
    <!-- endinject -->
    <!-- plugin css for this page -->
    <link rel="stylesheet" href="../../vendors/datatables.net-bs4/dataTables.bootstrap4.css">
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../../assets/images/favicon.png" />
</head>

<body>
    <div class="container-scroller">
        <!-- partial:partials/_navbar.html -->
        <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
            <div class="navbar-brand-wrapper d-flex justify-content-center">
                <div class="navbar-brand-inner-wrapper d-flex justify-content-between align-items-center w-100">
                    <a class="navbar-brand brand-logo" href="index.html"><img src="../../assets/images/logo.png" alt="logo" /></a>
                    <a class="navbar-brand brand-logo-mini" href="index.html"><img src="../../assets/images/logo-mini.png" alt="logo" /></a>
                    <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
            <span class="mdi mdi-sort-variant"></span>
          </button>
                </div>
            </div>
            <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">
                <ul class="navbar-nav mr-lg-4 w-100">
                    <li class="nav-item nav-search d-none d-lg-block w-100">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="search">
                  <i class="mdi mdi-magnify"></i>
                </span>
                            </div>
                            <input type="text" class="form-control" placeholder="Search now" aria-label="search" aria-describedby="search">
                        </div>
                    </li>
                </ul>
                <ul class="navbar-nav navbar-nav-right">
                    <li class="nav-item nav-profile dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" id="profileDropdown">
                            <img src="../../assets/images/avatar-person.svg" alt="profile" />
                            <span class="nav-profile-name">Unknown</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="profileDropdown">
                            <a class="dropdown-item">
                                <i class="mdi mdi-settings text-primary"></i> Settings
                            </a>
                            <a class="dropdown-item" id="logoutBtn">
                                <i class="mdi mdi-logout text-primary"></i> Logout
                            </a>
                        </div>
                    </li>
                </ul>
                <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
            <span class="mdi mdi-menu"></span>
        </button>
            </div>
        </nav>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial:partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
                <ul class="nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../pages/dashboard">
                            <i class="mdi mdi-home menu-icon"></i>
                            <span class="menu-title">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../../pages/area">
                            <i class="mdi mdi-image-area menu-icon"></i>
                            <span class="menu-title">Area</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../../pages/answerQuestion?page=1&per_page=10&status=PENDING">
                            <i class="mdi mdi-message-text menu-icon"></i>
                            <span class="menu-title">Answer Question</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="collapse" href="#user-actions" aria-expanded="false" aria-controls="user-actions">
                            <i class="mdi mdi-account-settings menu-icon"></i>
                            <span class="menu-title">Manage User</span>
                            <i class="menu-arrow"></i>
                        </a>
                        <div class="collapse" id="user-actions">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item"> <a class="nav-link" href="../../pages/user">View Members</a></li>
                                <li class="nav-item"> <a class="nav-link" href="../../pages/user/pending">Pending Members</a></li>
                                <li class="nav-item"> <a class="nav-link" href="../../pages/user/update">Update Member Details</a></li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="collapse" href="#content-actions" aria-expanded="false" aria-controls="content-actions">
                            <i class="mdi mdi-arrow-up-bold-hexagon-outline menu-icon"></i>
                            <span class="menu-title">Manage Static Content</span>
                            <i class="menu-arrow"></i>
                        </a>
                        <div class="collapse" id="content-actions">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item"><a class="nav-link" href="../../pages/publish/audio.html">Audio</a></li>
                                <li class="nav-item"><a class="nav-link" href="../../pages/publish/video.html">Video</a></li>
                                <li class="nav-item"><a class="nav-link" href="../../pages/publish/images.html">Images</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </nav>
            <!-- partial -->
            <div class="main-panel">
                <div class="content-wrapper">
                    <div class="row">
                        <div class="col-md-12 stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <p class="card-title">Questions</p>
                                    <div class="row">
                                        <div class="col col-md-4 col-lg-4 col-sm-12">
                                            <div class="form-group">
                                                <select class="form-control form-control-sm" id="questionStatus">
                                                  <option value="PENDING" selected>PENDING</option>
                                                  <option value="RESOLVED">RESOLVED</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col col-md-4 col-lg-4 col-sm-12">
                                            <nav aria-label="Pagination" style="width: fit-content;margin: auto;">
                                                <ul class="pagination">

                                                </ul>
                                            </nav>
                                        </div>
                                        <div class="col col-md-4 col-lg-4 col-sm-12">
                                            <div class="form-group">
                                                <select class="form-control form-control-sm" id="perPage">
                                                  <option value="10" selected>10</option>
                                                  <option value="25">25</option>
                                                  <option value="50">50</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <ul class="question-list"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal -->
            <div class="modal fade" id="questionModal" tabindex="-1" role="dialog" aria-labelledby="questionModalTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Question</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
                        </div>
                        <div class="modal-body">
                            <div class="question"></div>
                            <textarea class="answer-text" placeholder="Your Answer here..."></textarea>
                            <div id="controls">
                                <button class="btn btn-outline-primary btn-fw" id="recordButton">Record</button> <span class="or">&nbsp;or&nbsp;</span>
                                <button class="file-upload-browse btn btn-primary" id="uploadButton" type="button">Upload Answer File</button>
                                <input style="display: none;" type="file" name="img[]" class="file-upload-default" accept="audio/*">
                                <button class="btn btn-outline-warning btn-fw" id="pauseButton">Pause</button>
                                <button class="btn btn-outline-success btn-fw" id="stopButton">Stop</button>
                            </div>
                            <div id="recording-wrapper">
                                <div class="recording"></div>
                                <div class="recording-message"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary">Save changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<!-- plugins:js -->
<script src="../../vendors/base/vendor.bundle.base.js"></script>
<!-- endinject -->
<!-- Plugin js for this page-->
<!-- <script src="../../vendors/chart.js/Chart.min.js"></script> -->
<!-- <script src="../../vendors/datatables.net/jquery.dataTables.js"></script> -->
<!-- <script src="../../vendors/datatables.net-bs4/dataTables.bootstrap4.js"></script> -->
<!-- End plugin js for this page-->
<!-- inject:js -->
<script src="../../assets/js/off-canvas.js"></script>
<script src="../../assets/js/hoverable-collapse.js"></script>
<script src="../../assets/js/template.js"></script>
<!-- endinject -->
<!-- Custom js for this page-->
<script src="../../assets/js/dashboard.js"></script>
<!-- <script src="../../assets/js/data-table.js"></script>
<script src="../../assets/js/jquery.dataTables.js"></script>
<script src="../../assets/js/dataTables.bootstrap4.js"></script> -->
<script src="../../assets/js/constants.js"></script>
<script src="../../assets/js/recorder.js"></script>
<script src="../../assets/js/file-upload.js"></script>
<script src="./script.js"></script>
<script>
    URL = window.URL || window.webkitURL;

    var gumStream; //stream from getUserMedia()
    var rec; //Recorder.js object
    var input; //MediaStreamAudioSourceNode we'll be recording

    // shim for AudioContext when it's not avb.
    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var audioContext //audio context to help us record

    function uploadSuccessCb(response) {
        const downloadLink = response.data.path;
        console.log(response.data.path)
        this.ansFile = downloadLink
        $('#recordButton').hide();
        $('#pauseButton').hide();
        $('#stopButton').hide();
        $('#uploadButton').hide();
        $('#controls .or').hide();
        if (production)

            var au = $('<audio/>')
            .attr("controls", "true")
            .attr("src", safeLoadMedia(downloadLink));

        var div = $('<div/>')
            .append(au)
            .addClass("recording")
        $('#recording-wrapper .recording').replaceWith(div);
    }

    function startRecording() {
        try {
            /*
        Simple constraints object, for more advanced audio features see
        https://addpipe.com/blog/audio-constraints-getusermedia/
    */

            var constraints = {
                audio: true,
                video: false
            }

            /*
         Disable the record button until we get a success or fail from getUserMedia()
     */

            $("#recordButton").hide();
            $("#stopButton").show();
            $("#pauseButton").show();
            $('#uploadButton').hide();
            $('#controls .or').hide();

            /*
                We're using the standard promise based getUserMedia()
                https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia
            */
            navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {

                /*
                    create an audio context after getUserMedia is called
                    sampleRate might change after getUserMedia is called, like it does on macOS when recording through AirPods
                    the sampleRate defaults to the one set in your OS for your playback device
                */
                audioContext = new AudioContext();

                //update the format
                // document.getElementById("formats").innerHTML="Format: 1 channel pcm @ "+audioContext.sampleRate/1000+"kHz"

                /*  assign to gumStream for later use  */
                gumStream = stream;

                /* use the stream */
                input = audioContext.createMediaStreamSource(stream);

                /*
                    Create the Recorder object and configure to record mono sound (1 channel)
                    Recording 2 channels  will double the file size
                */
                rec = new Recorder(input, {
                    numChannels: 1
                })

                //start the recording process
                rec.record()

            }).catch(function(err) {
                console.log(err);
            });
        } catch (e) {
            alert(e)

        }
    }


    function pauseRecording() {
        if (rec.recording) {
            //pause
            rec.stop();
            $("#pauseButton").text("Resume");
        } else {
            //resume
            rec.record()
            $("#pauseButton").text("Pause");

        }
    }

    function stopRecording(filename) {

        //disable the stop button, enable the record too allow for new recordings
        try {
            $("#recordButton").show();
            $("#stopButton").hide();
            $("#pauseButton").hide().text("Pause");

            //tell the recorder to stop the recording
            rec.stop();

            //stop microphone access
            gumStream.getAudioTracks()[0].stop();

            //create the wav blob and pass it on to createDownloadLink
            rec.exportWAV(function(blob) {
                createDownloadLink(blob, filename)
            });
        } catch (e) {
            alert(e)
        }
    }

    function createDownloadLink(blob, filename) {

        var url = URL.createObjectURL(blob);
        var downloadLink;

        //name of .wav file to use during upload and download (without extendion)
        // var filename = new Date().toISOString();

        //add controls to the <audio> element
        var au = $('<audio/>')
            .attr("controls", "true")
            .attr("src", safeLoadMedia(url));

        var div = $('<div/>')
            .append(au)
            .addClass("recording")

        var fd = new FormData();
        fd.append("file", blob, filename + ".wav");
        // div.appendChild(document.createTextNode (" "))//add a space in between
        // div.appendChild(upload)//add the upload link to div
        div.append($('<button/>')
            .text("Upload")
            .addClass("btn btn-primary")
            .click(function() {
                var button = $(this);
                $.ajax({
                    type: "POST",
                    url: `${API_BASE_URL}/upload`,
                    cors: true,
                    contentType: false,
                    processData: false,
                    secure: true,
                    headers: {
                        'Access-Control-Allow-Origin': '*',

                    },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("access_token", localStorage.getItem('token'));
                    },
                    data: fd,
                    success: function(response) {
                        downloadLink = response.data.path;
                        setTimeout(function() {
                            this.ansFile = downloadLink
                        });
                        $(button).remove();
                        $('#recordButton').hide();
                        $('#pauseButton').hide();
                        $('#stopButton').hide();
                    },
                    error: function(err) {
                        alert(JSON.stringify(err));
                    },
                });
            }))

        //add the div element to the ol
        // recordingWrapper.replaceWith(div);
        $('#recording-wrapper .recording').replaceWith(div);
    }
    //==========================================================================================
    const state = {};
    $(document).ready(function() {
        function getQueryStringValue(key) {
            return decodeURIComponent(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + encodeURIComponent(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
        }
        const per_page = getQueryStringValue("per_page") || 10;
        const page = +getQueryStringValue("page") || 1;
        const answer = +(getQueryStringValue("status") === 'RESOLVED');
        try {
            const userProfile = JSON.parse(localStorage.getItem('userProfile'));
            $.ajax({
                type: "GET",
                url: `${API_BASE_URL}/question?${$.param({
                answer,
                per_page,
                page,
                })}`,
                dataType: 'json',
                cors: true,
                contentType: 'application/json',
                secure: true,
                headers: {
                    'Access-Control-Allow-Origin': '*',

                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("access_token", localStorage.getItem('token'));
                },
                success: function(response) {
                    const questions = response.data && response.data.data;
                    const cList = $('ul.question-list');
                    const pagination = $('ul.pagination');
                    const prevButton = $('<li/>')
                        .addClass('page-item')
                        .addClass(response.data.total_pages < 2 || response.data.current_page == 1 ? 'disabled' : '')
                        .html(`<a class = "page-link" href = "?page=${page-1}&status=${answer ? 'RESOLVED' : 'PENDING'}&per_page=${per_page}" tabindex = "-1" > Previous `);
                    const nextButton = $('<li/>')
                        .addClass('page-item')
                        .addClass(response.data.total_pages < 2 || response.data.current_page == response.data.total_pages ? 'disabled' : '')
                        .html(`<a class = "page-link" href = "?page=${page+1}&status=${answer ? 'RESOLVED' : 'PENDING'}&per_page=${per_page}" tabindex = "-1" > Next `);
                    prevButton.appendTo(pagination)
                    for (let i = 1; i <= response.data.total_pages; i++) {
                        $('<li/>')
                            .addClass('page-item')
                            .addClass(response.data.current_page == i ? 'active' : '')
                            .html(response.data.current_page == i ? `<a class = "page-link" href = "#" tabindex = "-1" > ${i} ` : `<a class = "page-link" href = "?page=${i}&status=${answer ? 'RESOLVED' : 'PENDING'}&per_page=${per_page}" tabindex = "-1" > ${i} `)
                            .appendTo(pagination);

                    }
                    nextButton.appendTo(pagination);
                    $.each(questions, function(i) {
                        var li = $('<li/>')
                            .addClass('question-item')
                            .appendTo(cList);
                        $('<span/>')
                            .addClass('question-category green')
                            .text(QUESTION_CATEGORY[questions[i].category])
                            .appendTo(li);
                        $('<span/>')
                            .addClass('question-category yellow')
                            .text(answer == 0 ? 'PENDING' : 'RESOLVED')
                            .appendTo(li);
                        $('<p/>')
                            .addClass('question')
                            .text(questions[i].askText)
                            .appendTo(li);
                        // $('<div/>')
                        //   .addClass('question-details')
                        //   .text(`Asked to: ${questions[i].askName}`)
                        //   .appendTo(li);
                        if (questions[i].askAudio) {
                            $('<audio/>')
                                .attr('src', safeLoadMedia(questions[i].askAudio))
                                .attr('controls', true)
                                .appendTo(li);
                        }
                        $('<div/>')
                            .addClass('question-details')
                            .text(`Asked by: ${(questions[i].askById && questions[i].askById.name) || questions[i].askName}`)
                            .appendTo(li);
                        const date = new Date(questions[i].askTime || questions[i].createdAt);
                        const year = new Intl.DateTimeFormat('en', {
                            year: 'numeric'
                        }).format(date);
                        const month = new Intl.DateTimeFormat('en', {
                            month: 'short'
                        }).format(date);
                        const day = new Intl.DateTimeFormat('en', {
                            day: '2-digit'
                        }).format(date);
                        $('<div/>')
                            .addClass('question-details')
                            .text(`Asked on: ${day} ${month} ${year}`)
                            .appendTo(li);
                        if (answer == 0) {
                            $('<button/>')
                                .addClass('btn btn-primary')
                                .click(function() {
                                    delete window.ansFile;
                                    state.questionId = questions[i]._id;
                                    $('#questionModal .recording').empty();
                                    $('#questionModal .recording-message').empty();
                                    $('#questionModal .modal-body .question').text(questions[i].askText);
                                    $('#recordButton').show().click(startRecording);
                                    $('#pauseButton').hide().click(pauseRecording);
                                    $('#stopButton').hide().click(stopRecording);
                                    $('#uploadButton').show();
                                    $('#controls .or').show();
                                })
                                .attr('data-toggle', 'modal')
                                .attr('data-target', "#questionModal")
                                .text('Reply')
                                .appendTo(li);
                        }
                    });


                },
                error: function(err) {
                    alert(JSON.stringify(err && err.responseJSON && err.responseJSON.data && err.responseJSON.data[0]));
                },
            });
        } catch (err) {
            logout();
        }

        $("#questionModal .modal-footer .btn-primary").click(function(e) {
            const ansText = $.trim($("#questionModal textarea").val());
            const ansFile = window.ansFile;
            if (ansText || ansFile) {
                state.payload = {};
                if (ansText) {
                    state.payload.ansText = ansText;
                }
                if (ansFile) {
                    state.payload.ansAudio = ansFile;
                }
                try {
                    state.payload.ansBy = JSON.parse(localStorage.getItem('userProfile'))._id;
                } catch (err) {
                    state.payload.ansBy = "Unknown";
                }
                $.ajax({
                    type: "PUT",
                    url: `${API_BASE_URL}/question/${state.questionId}`,
                    cors: true,
                    contentType: 'application/json',
                    dataType: 'json',
                    processData: false,
                    secure: true,
                    headers: {
                        'Access-Control-Allow-Origin': '*',
                    },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("access_token", localStorage.getItem('token'));
                    },
                    data: JSON.stringify(state.payload),
                    success: function(response) {
                        window.location.reload();
                    },
                    error: function(err) {
                        alert(JSON.stringify(err));
                    },
                });
                $('#questionModal').modal('toggle');
            } else {
                e.preventDefault();
                $('#recording-wrapper .recording-message').empty().text('Either Add Answer Text or Record & Upload Answer Audio');
            }
        })

        $('#questionStatus').on('change', function() {
            window.location.href = window.location.href.split(window.location.search)[0] + '?' + $.param({
                status: this.value,
                per_page,
                page: 1,
            })
        }).val(answer ? 'RESOLVED' : 'PENDING');

        $('#perPage').on('change', function() {
            window.location.href = window.location.href.split(window.location.search)[0] + '?' + $.param({
                status: answer ? 'RESOLVED' : 'PENDING',
                per_page: this.value,
                page: 1,
            })
        }).val(per_page);
    });
</script>

</html>